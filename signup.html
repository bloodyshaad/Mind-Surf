<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - MindSurf</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/auth.css">
</head>
<body>
    <div class="auth-page">
        <div class="auth-container">
            <div class="auth-left">
                <div class="auth-brand">
                    <svg class="logo-icon" viewBox="0 0 50 50" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M25 5C14.5 5 6 13.5 6 24C6 34.5 14.5 43 25 43C35.5 43 44 34.5 44 24C44 13.5 35.5 5 25 5Z" stroke="currentColor" stroke-width="2"/>
                        <path d="M15 24C15 24 18 18 25 18C32 18 35 24 35 24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <circle cx="20" cy="20" r="2" fill="currentColor"/>
                        <circle cx="30" cy="20" r="2" fill="currentColor"/>
                    </svg>
                    <h1>MindSurf</h1>
                </div>
                <p class="auth-tagline">Start your journey to better stress management today</p>
                <div class="auth-features">
                    <div class="feature-item">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <span>Takes only 5 minutes to get started</span>
                    </div>
                    <div class="feature-item">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2"/>
                            <path d="M12 16V12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <circle cx="12" cy="8" r="1" fill="currentColor"/>
                        </svg>
                        <span>Free and confidential</span>
                    </div>
                    <div class="feature-item">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        <span>Designed specifically for teens</span>
                    </div>
                </div>
            </div>
            
            <div class="auth-right">
                <div class="auth-form-container">
                    <h2>Create Your Account</h2>
                    <p class="auth-subtitle">Join MindSurf and start managing stress effectively</p>
                    
                    <form id="signupForm" class="auth-form">
                        <div class="form-group">
                            <label for="fullName">Full Name</label>
                            <input type="text" id="fullName" name="fullName" required placeholder="John Doe" autocomplete="name">
                        </div>
                        
                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <input type="email" id="email" name="email" required placeholder="your.email@example.com" autocomplete="email">
                        </div>
                        
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" id="password" name="password" required placeholder="Minimum 6 characters" autocomplete="new-password">
                            <small>Must be at least 6 characters long</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="age">Age</label>
                            <input type="number" id="age" name="age" required placeholder="13-19" min="13" max="19">
                            <small>You must be between 13-19 years old</small>
                        </div>
                        
                        <div id="errorMessage" class="error-message"></div>
                        <div id="successMessage" class="success-message"></div>
                        
                        <button type="submit" class="btn-primary btn-full" id="signupBtn">
                            <span class="btn-text">Create Account</span>
                            <span class="btn-loader" style="display: none;">
                                <span class="loader"></span>
                            </span>
                        </button>
                    </form>
                    
                    <div class="auth-divider">
                        <span>OR</span>
                    </div>
                    
                    <button type="button" class="btn-oauth btn-google" id="googleSignupBtn">
                        <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/>
                            <path d="M9.003 18c2.43 0 4.467-.806 5.956-2.18L12.05 13.56c-.806.54-1.836.86-3.047.86-2.344 0-4.328-1.584-5.036-3.711H.96v2.332C2.44 15.983 5.485 18 9.003 18z" fill="#34A853"/>
                            <path d="M3.964 10.712c-.18-.54-.282-1.117-.282-1.71 0-.593.102-1.17.282-1.71V4.96H.957C.347 6.175 0 7.55 0 9.002c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/>
                            <path d="M9.003 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.464.891 11.428 0 9.003 0 5.485 0 2.44 2.017.96 4.958L3.967 7.29c.708-2.127 2.692-3.71 5.036-3.71z" fill="#EA4335"/>
                        </svg>
                        Continue with Google
                    </button>
                    
                    <div class="auth-footer">
                        <p>Already have an account? <a href="login.html">Login</a></p>
                        <p><a href="index.html">Back to home</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script>
        const signupForm = document.getElementById('signupForm');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const signupBtn = document.getElementById('signupBtn');
        const btnText = signupBtn.querySelector('.btn-text');
        const btnLoader = signupBtn.querySelector('.btn-loader');

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fullName = document.getElementById('fullName').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const age = parseInt(document.getElementById('age').value);
            
            // Validation
            if (password.length < 6) {
                errorMessage.textContent = 'Password must be at least 6 characters';
                errorMessage.style.display = 'block';
                return;
            }
            
            if (age < 13 || age > 19) {
                errorMessage.textContent = 'Age must be between 13 and 19';
                errorMessage.style.display = 'block';
                return;
            }
            
            // Show loading
            btnText.style.display = 'none';
            btnLoader.style.display = 'inline-block';
            signupBtn.disabled = true;
            errorMessage.textContent = '';
            errorMessage.style.display = 'none';
            successMessage.textContent = '';
            successMessage.style.display = 'none';

            try {
                // Register user with Supabase Auth
                // The trigger will automatically create the user profile
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            full_name: fullName,
                            age: age
                        },
                        emailRedirectTo: window.location.origin
                    }
                });

                if (authError) throw authError;

                // Check if user was created
                if (!authData.user) {
                    throw new Error('Registration failed. Please try again.');
                }

                // Check if email confirmation is required
                if (authData.session) {
                    // Auto-confirmed, redirect to main page
                    successMessage.textContent = 'Account created successfully! Redirecting...';
                    successMessage.style.display = 'block';
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                } else {
                    // Email confirmation required
                    successMessage.textContent = 'Account created! You can now login.';
                    successMessage.style.display = 'block';
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                }

            } catch (error) {
                errorMessage.textContent = error.message || 'Registration failed. Please try again.';
                errorMessage.style.display = 'block';
                btnText.style.display = 'inline';
                btnLoader.style.display = 'none';
                signupBtn.disabled = false;
            }
        });

        // Google OAuth Signup
        const googleSignupBtn = document.getElementById('googleSignupBtn');
        googleSignupBtn.addEventListener('click', async () => {
            try {
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin + '/index.html',
                        queryParams: {
                            access_type: 'offline',
                            prompt: 'consent',
                        }
                    }
                });

                if (error) {
                    errorMessage.textContent = 'Failed to sign up with Google. Please try again.';
                    errorMessage.style.display = 'block';
                    console.error('Google OAuth error:', error);
                }
            } catch (error) {
                errorMessage.textContent = 'Failed to sign up with Google. Please try again.';
                errorMessage.style.display = 'block';
                console.error('Google OAuth error:', error);
            }
        });
    </script>
</body>
</html>
